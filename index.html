<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÉ –•–µ–ª–ª–æ–≤—ñ–Ω: –õ–æ–≤–∏ –º–æ–Ω—Å—Ç—Ä—ñ–≤! üëª</title>

    <!-- A-Frame + MindAR -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        .arjs-loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #ff8c00;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            font-family: 'Comic Sans MS', cursive;
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .ui-info-text {
            position: fixed;
            background: rgba(0, 0, 0, 0.7);
            color: #ff8c00;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: 'Comic Sans MS', cursive;
        }
        #taskText { top: 10px; left: 10px; }
        #timerText { top: 10px; right: 10px; }
        #scoreText { bottom: 10px; left: 10px; }
        .kid-friendly-btn {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #ff8c00;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            display: none;
        }
        #kidPauseBtn { top: 20%; right: 10px; }
        #kidStopBtn { top: 35%; right: 10px; }
        #kidSoundBtn { top: 50%; right: 10px; }
        #kidHomeBtn { top: 65%; right: 10px; }
        #endMessage, #errorOverlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: #ff8c00;
            padding: 20px;
            border-radius: 15px;
            z-index: 10000;
            text-align: center;
            font-family: 'Comic Sans MS', cursive;
        }
        #errorOverlay { display: none; }
        #fpsCounter {
            position: fixed;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 30000;
            font-family: monospace;
        }
        .ui-btn {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: #ff8c00;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1.2em;
            cursor: pointer;
        }
        #canvasGameContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #gameCanvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="arjs-loader" id="loader">
        <div class="pulse">üéÉ –õ–û–í–ò –û–î–ù–ê–ö–û–í–ò–• –ú–û–ù–°–¢–†–Ü–í! üëª</div>
        <div style="margin-top: 15px; font-size: 0.9em;">
            –ù–ê–í–ï–î–ò –ù–ê –†–û–ó–ú–ê–õ–¨–û–í–ö–£! üéÉ
        </div>
    </div>

    <div id="instruction">
        üéÉ –ù–ê–í–ï–î–ò –ù–ê –†–û–ó–ú–ê–õ–¨–û–í–ö–£, –©–û–ë –ü–û–ß–ê–¢–ò! üëª
    </div>

    <p id="taskText" class="ui-info-text">–õ–û–í–ò –û–î–ù–ê–ö–û–í–ò–• –ú–û–ù–°–¢–†–Ü–í! üëª</p>
    <p id="timerText" class="ui-info-text">‚è≥ –ß–ê–°: 60</p>
    <p id="scoreText" class="ui-info-text">üéØ –ë–ê–õ–ò: 0</p>
    <p id="feedbackMessage">–ú–û–õ–û–î–ï–¶–¨! üëª</p>

    <button id="kidPauseBtn" class="kid-friendly-btn" title="–ü–∞—É–∑–∞">‚è∏Ô∏è</button>
    <button id="kidStopBtn" class="kid-friendly-btn" title="–°—Ç–æ–ø">üõë</button>
    <button id="kidSoundBtn" class="kid-friendly-btn" title="–ó–≤—É–∫">üîä</button>
    <button id="kidHomeBtn" class="kid-friendly-btn" title="–î–æ–¥–æ–º—É">üè†</button>

    <div id="canvasGameContainer">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="endMessage" style="display:none;"></div>

    <div id="errorOverlay" style="display:none;">
        <h2>‚ö†Ô∏è –©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫</h2>
        <p id="errorMessage">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>
        <button id="retryBtn" style="margin-top:20px; padding:12px 24px; background:#ff8c00; color:white; border:none; border-radius:30px; font-size:1.1em; cursor:pointer;">üîÑ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
    </div>

    <div id="fpsCounter"></div>

    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
    >
        <a-assets>
            <audio id="bg-music" src="./bg-music.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="click-sound" src="./boo.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="logo-sound" src="./boo.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="boo-sound" src="./boo.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="success-sound" src="./boo.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <img id="logo-img" src="./logo.png" crossorigin="anonymous" alt="–•–µ–ª–ª–æ–≤—ñ–Ω—Å—å–∫–∏–π –±—É–¥–∏–Ω–æ–∫">
        </a-assets>

        <a-camera look-controls="enabled: false" position="0 0 0">
            <a-cursor raycaster="objects: .emoji;" cursor="fuse: false; maxDistance: 10"
                position="0 0 -1" geometry="primitive: ring; radiusOuter: 0.015; radiusInner: 0.008"
                material="color: #ff8c00; shader: flat"></a-cursor>
        </a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-image id="logo-image" src="#logo-img" position="0 0 0.03" rotation="30 0 0"
                scale="1.5 1.5 1.5" visible="false" transparent="true" alpha-test="0.6"
                material="shader: flat"></a-image>
            <a-entity id="game-elements" visible="false"></a-entity>
        </a-entity>
    </a-scene>

    <button id="playBtn" class="ui-btn">üöÄ –ü–û–ß–ê–¢–ò –ì–†–£! üëª</button>
    <button id="resetBtn" class="ui-btn">üîÑ –ì–†–ê–¢–ò –©–ï! üéÉ</button>
    <button id="soundBtn" class="ui-btn" style="display: none;">üîä –£–í–Ü–ú–ö–ù–£–¢–ò –ó–í–£–ö–ò!</button>
    <a href="https://www.youtube.com/@23smartlessa32?si=d3NhKDot8U8Mc2Hi" id="youtubeBtn" target="_blank">‚ù§Ô∏è –ê–í–¢–û–†</a>

    <script>
        class ARGame {
            constructor() {
                this.state = {
                    isGameRunning: false,
                    isGamePaused: false,
                    arStarted: false,
                    score: 0,
                    startTime: null,
                    animationFrameId: null,
                    logoAppearTimeout: null,
                    emojis: [],
                    selectedEmojis: [],
                    particles: [],
                    lastGeneration: 0,
                    generationInterval: 1000,
                    emojiTypes: ['üëª', 'üéÉ', 'üï∑Ô∏è', 'ü¶á', 'üíÄ', 'üòà'],
                    maxEmojisOnScreen: 4
                };
                this.elements = {
                    loader: document.querySelector('#loader'),
                    targetEntity: document.querySelector('a-entity[mindar-image-target]'),
                    logoImage: document.querySelector('#logo-image'),
                    playBtn: document.querySelector('#playBtn'),
                    resetBtn: document.querySelector('#resetBtn'),
                    soundBtn: document.querySelector('#soundBtn'),
                    youtubeBtn: document.querySelector('#youtubeBtn'),
                    taskText: document.getElementById('taskText'),
                    timerText: document.getElementById('timerText'),
                    scoreText: document.getElementById('scoreText'),
                    instruction: document.querySelector('#instruction'),
                    bgMusic: document.querySelector('#bg-music'),
                    logoSound: document.querySelector('#logo-sound'),
                    clickSound: document.querySelector('#click-sound'),
                    booSound: document.querySelector('#boo-sound'),
                    successSound: document.querySelector('#success-sound'),
                    endMessage: document.getElementById('endMessage'),
                    feedbackMessage: document.getElementById('feedbackMessage'),
                    aScene: document.querySelector('a-scene'),
                    canvas: document.getElementById('gameCanvas'),
                    errorOverlay: document.getElementById('errorOverlay'),
                    errorMessage: document.getElementById('errorMessage'),
                    retryBtn: document.getElementById('retryBtn'),
                    fpsCounter: document.getElementById('fpsCounter')
                };
                this.gameControls = {
                    pauseBtn: document.getElementById('kidPauseBtn'),
                    stopBtn: document.getElementById('kidStopBtn'),
                    soundBtn: document.getElementById('kidSoundBtn'),
                    homeBtn: document.getElementById('kidHomeBtn')
                };
                this.fontCache = new Map();
                this.resizeObserver = null;
                this.lastFrameTime = performance.now();
                this.frameCount = 0;
                this.fps = 60;
                this.init();
            }
            init() {
                try {
                    this.bindEvents();
                    this.setupResizeHandling();
                    this.updateUIForAR();
                    setTimeout(() => {
                        if (!this.state.arStarted) {
                            this.elements.instruction.style.display = 'block';
                        }
                    }, 1500);
                } catch (error) {
                    this.showError('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó', error);
                }
            }
            bindEvents() {
                const { playBtn, resetBtn, soundBtn, youtubeBtn, targetEntity } = this.elements;
                const { pauseBtn, stopBtn, soundBtn: kidSoundBtn, homeBtn } = this.gameControls;
                playBtn?.addEventListener('click', () => this.startCanvasGame());
                resetBtn?.addEventListener('click', () => this.resetGame());
                soundBtn?.addEventListener('click', () => this.enableAllAudio());
                youtubeBtn?.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.open('https://www.youtube.com/@23smartlessa32?si=d3NhKDot8U8Mc2Hi', '_blank');
                });
                pauseBtn?.addEventListener('click', () => this.togglePause());
                stopBtn?.addEventListener('click', () => this.stopGame());
                kidSoundBtn?.addEventListener('click', () => this.toggleGameSound());
                homeBtn?.addEventListener('click', () => this.goToHome());
                this.elements.retryBtn?.addEventListener('click', () => this.retry());
                targetEntity?.addEventListener('targetFound', () => this.onTargetFound());
                targetEntity?.addEventListener('targetLost', () => this.onTargetLost());
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') this.stopAllAudio();
                });
            }
            setupResizeHandling() {
                const updateSize = () => {
                    document.body.style.height = window.innerHeight + 'px';
                    if (this.state.isGameRunning && this.elements.canvas) {
                        this.elements.canvas.width = window.innerWidth;
                        this.elements.canvas.height = window.innerHeight;
                    }
                };
                updateSize();
                this.resizeObserver = new ResizeObserver(() => {
                    setTimeout(updateSize, 250);
                });
                this.resizeObserver.observe(document.body);
            }
            showError(message, error = null) {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞:', message, error);
                this.elements.errorMessage.textContent = message;
                this.elements.errorOverlay.style.display = 'flex';
            }
            retry() {
                this.elements.errorOverlay.style.display = 'none';
                this.init();
            }
            stopAllAudio() {
                [this.elements.bgMusic, this.elements.logoSound, this.elements.clickSound,
                 this.elements.booSound, this.elements.successSound].forEach(audio => {
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.muted = true;
                    }
                });
            }
            playSound(soundElement) {
                if (soundElement && !soundElement.muted) {
                    soundElement.currentTime = 0;
                    soundElement.play().catch(e => console.warn("üîá –ó–≤—É–∫ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è:", e));
                }
            }
            enableAllAudio() {
                [this.elements.bgMusic, this.elements.logoSound, this.elements.clickSound,
                 this.elements.booSound, this.elements.successSound].forEach(audio => {
                    if (audio) audio.muted = false;
                });
                this.elements.soundBtn.style.display = 'none';
            }
            toggleGameSound() {
                const isMuted = this.elements.bgMusic.muted;
                [this.elements.bgMusic, this.elements.clickSound, this.elements.successSound]
                    .forEach(audio => { if (audio) audio.muted = !isMuted; });
                this.gameControls.soundBtn.innerHTML = isMuted ? 'üîä' : 'üîá';
                this.gameControls.soundBtn.title = isMuted ? "–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫" : "–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫";
            }
            onTargetFound() {
                console.log("üéØ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!");
                this.state.arStarted = true;
                this.elements.loader.style.display = 'none';
                this.elements.instruction.style.display = 'none';
                this.elements.aScene.style.display = 'block';
                this.elements.aScene.style.animation = 'arSceneAppear 1s ease-in forwards';
                this.showLogo();
                this.playSound(this.elements.booSound);
                if (!this.state.isGameRunning) this.updateUIForAR();
            }
            onTargetLost() {
                this.hideLogo();
                if (!this.state.isGameRunning) this.hideUIForAR();
            }
            showLogo() {
                if (!this.elements.logoImage) return;
                this.elements.logoImage.setAttribute('visible', 'false');
                this.elements.logoImage.classList.remove('logo-appear', 'logo-float');
                if (this.state.logoAppearTimeout) clearTimeout(this.state.logoAppearTimeout);
                this.state.logoAppearTimeout = setTimeout(() => {
                    this.elements.logoImage.setAttribute('visible', 'true');
                    this.elements.logoImage.classList.add('logo-appear');
                    this.playSound(this.elements.logoSound);
                    setTimeout(() => {
                        this.elements.logoImage.classList.remove('logo-appear');
                        this.elements.logoImage.classList.add('logo-float');
                    }, 3000);
                }, 100);
            }
            hideLogo() {
                if (!this.elements.logoImage) return;
                this.elements.logoImage.setAttribute('visible', 'false');
                this.elements.logoImage.classList.remove('logo-appear', 'logo-float');
                if (this.state.logoAppearTimeout) clearTimeout(this.state.logoAppearTimeout);
            }
            updateUIForAR() {
                if (!this.state.isGameRunning) {
                    this.elements.playBtn.style.display = 'block';
                    this.elements.soundBtn.style.display = 'block';
                    this.elements.youtubeBtn.style.display = 'block';
                    this.hideGameControls();
                }
            }
            hideUIForAR() {
                this.elements.playBtn.style.display = 'none';
                this.elements.soundBtn.style.display = 'none';
                this.elements.youtubeBtn.style.display = 'none';
            }
            showGameControls() {
                Object.values(this.gameControls).forEach(btn => {
                    if (btn) btn.style.display = 'flex';
                });
            }
            hideGameControls() {
                Object.values(this.gameControls).forEach(btn => {
                    if (btn) btn.style.display = 'none';
                });
            }
            startCanvasGame() {
                try {
                    this.state.isGameRunning = true;
                    this.state.isGamePaused = false;
                    this.hideUIForAR();
                    this.showGameControls();
                    this.hideLogo();
                    this.elements.canvasGameContainer.style.display = 'block';
                    this.initCanvasGame();
                } catch (error) {
                    this.showError('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –≥—Ä—É', error);
                }
            }
            stopGame() {
                if (!this.state.isGameRunning) return;
                this.state.isGameRunning = false;
                this.state.isGamePaused = false;
                this.hideGameControls();
                this.elements.resetBtn.style.display = 'none';
                this.updateUIForAR();
                this.elements.canvasGameContainer.style.display = 'none';
                this.elements.aScene.style.display = 'block';
                this.elements.taskText.style.display = 'none';
                this.elements.timerText.style.display = 'none';
                this.elements.scoreText.style.display = 'none';
                this.elements.feedbackMessage.style.display = 'none';
                this.elements.endMessage.style.display = 'none';
                this.stopAllAudio();
                if (this.state.animationFrameId) {
                    cancelAnimationFrame(this.state.animationFrameId);
                    this.state.animationFrameId = null;
                }
                this.hidePauseMessage();
                this.showLogo();
            }
            resetGame() {
                this.stopGame();
                this.state.score = 0;
                this.state.emojis = [];
                this.state.selectedEmojis = [];
                this.state.particles = [];
                this.state.startTime = null;
                this.elements.scoreText.textContent = `üéØ –ë–ê–õ–ò: 0`;
                this.elements.timerText.textContent = `‚è≥ –ß–ê–°: 60`;
                this.elements.taskText.textContent = `–õ–û–í–ò –û–î–ù–ê–ö–û–í–ò–• –ú–û–ù–°–¢–†–Ü–í! üëª`;
                this.updateUIForAR();
                this.elements.resetBtn.style.display = 'none';
            }
            goToHome() {
                this.stopGame();
                this.updateUIForAR();
            }
            async initCanvasGame() {
                const { canvas } = this.elements;
                if (!canvas) return this.showError("Canvas –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
                const ctx = canvas.getContext('2d');
                if (!ctx) return this.showError("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ 2D –∫–æ–Ω—Ç–µ–∫—Å—Ç");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                this.playSound(this.elements.bgMusic);
                this.state.startTime = Date.now();
                this.elements.taskText.style.display = 'block';
                this.elements.timerText.style.display = 'block';
                this.elements.scoreText.style.display = 'block';
                this.elements.timerText.textContent = `‚è≥ –ß–ê–°: 60`;
                this.elements.scoreText.textContent = `üéØ –ë–ê–õ–ò: ${this.state.score}`;
                this.setupInputHandler(canvas);
                this.state.lastGeneration = Date.now();
                this.state.emojis = [];
                this.generateEmojis();
                this.state.animationFrameId = requestAnimationFrame((time) => this.animate(time));
            }
            setupInputHandler(canvas) {
                const handler = (e) => this.handleInput(e, canvas);
                canvas.addEventListener('click', handler);
                canvas.addEventListener('touchstart', handler, { passive: false });
                this.inputHandler = handler;
            }
            handleInput(e, canvas) {
                if (this.state.isGamePaused || !this.state.isGameRunning) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || (e.touches?.[0]?.clientX)) - rect.left;
                const y = (e.clientY || (e.touches?.[0]?.clientY)) - rect.top;
                for (let i = this.state.emojis.length - 1; i >= 0; i--) {
                    const emoji = this.state.emojis[i];
                    if (emoji.isClicked || emoji.fadeOut > 0 || emoji.shake > 0) continue;
                    const dx = x - emoji.x;
                    const dy = y - emoji.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < emoji.size / 1.5) {
                        emoji.isClicked = true;
                        this.state.selectedEmojis.push(emoji);
                        this.playSound(this.elements.clickSound);
                        this.processSelection();
                        break;
                    }
                }
            }
            processSelection() {
                const { selectedEmojis } = this.state;
                if (selectedEmojis.length === 2) {
                    if (selectedEmojis[0].value === selectedEmojis[1].value) {
                        selectedEmojis.forEach(emoji => {
                            emoji.fadeOut = 1;
                            for (let i = 0; i < 15; i++) {
                                this.state.particles.push(this.createParticle(emoji.x, emoji.y));
                            }
                        });
                        this.state.score += 2;
                        this.elements.scoreText.textContent = `üéØ –ë–ê–õ–ò: ${this.state.score}`;
                        this.playSound(this.elements.successSound);
                        this.showFeedback(`–ú–û–õ–û–î–ï–¶–¨! +2 –ë–ê–õ–ò! ${selectedEmojis[0].value}`);
                        setTimeout(() => {
                            this.hideFeedback();
                            this.state.selectedEmojis = [];
                            this.generateEmojis();
                        }, 600);
                    } else {
                        selectedEmojis.forEach(emoji => {
                            emoji.shake = 6;
                            setTimeout(() => {
                                emoji.isClicked = false;
                                emoji.shake = 0;
                            }, 600);
                        });
                        this.showFeedback(`–õ–û–í–ò –û–î–ù–ê–ö–û–í–Ü –ï–õ–ï–ú–ï–ù–¢–ò! üëª`);
                        setTimeout(() => {
                            this.hideFeedback();
                            this.state.selectedEmojis = [];
                        }, 1000);
                    }
                } else {
                    this.showFeedback(`–û–ë–ï–†–ò –©–ï –û–î–ò–ù –ï–õ–ï–ú–ï–ù–¢! üëª`);
                    setTimeout(() => this.hideFeedback(), 600);
                }
            }
            showFeedback(text) {
                this.elements.feedbackMessage.textContent = text;
                this.elements.feedbackMessage.style.display = 'block';
            }
            hideFeedback() {
                this.elements.feedbackMessage.style.display = 'none';
            }
            showPauseMessage() {
                const pauseMsg = document.createElement('div');
                pauseMsg.id = 'pauseMessage';
                pauseMsg.innerHTML = '‚è∏Ô∏è –ì–†–ê –ù–ê –ü–ê–£–ó–Ü<br><span style="font-size: 0.8em;">–¢–æ—Ä–∫–Ω–∏—Å—å –∫–Ω–æ–ø–∫–∏ ‚ñ∂Ô∏è —â–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</span>';
                pauseMsg.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9); color: #ff8c00; padding: 20px; border-radius: 20px;
                    text-align: center; z-index: 1002; font-size: 1.5em;
                    font-family: 'Comic Sans MS', cursive; border: 3px solid #ff8c00; backdrop-filter: blur(8px);
                `;
                document.body.appendChild(pauseMsg);
            }
            hidePauseMessage() {
                const el = document.getElementById('pauseMessage');
                if (el) el.remove();
            }
            togglePause() {
                this.state.isGamePaused = !this.state.isGamePaused;
                if (this.state.isGamePaused) {
                    cancelAnimationFrame(this.state.animationFrameId);
                    this.gameControls.pauseBtn.innerHTML = '‚ñ∂Ô∏è';
                    this.gameControls.pauseBtn.title = "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏";
                    this.showPauseMessage();
                } else {
                    this.state.animationFrameId = requestAnimationFrame((time) => this.animate(time));
                    this.gameControls.pauseBtn.innerHTML = '‚è∏Ô∏è';
                    this.gameControls.pauseBtn.title = "–ü–∞—É–∑–∞";
                    this.hidePauseMessage();
                }
            }
            createEmoji() {
                return {
                    x: Math.random() * this.elements.canvas.width,
                    y: Math.random() * this.elements.canvas.height,
                    size: 50 + Math.random() * 30,
                    vx: (Math.random() - 0.5) * 3,
                    vy: (Math.random() - 0.5) * 3,
                    value: this.state.emojiTypes[Math.floor(Math.random() * this.state.emojiTypes.length)],
                    isClicked: false,
                    fadeOut: 0,
                    shake: 0,
                    wiggle: Math.random() * Math.PI * 2,
                    creationTime: Date.now(),
                    lifetime: 5000 + Math.random() * 3000
                };
            }
            createParticle(x, y) {
                return {
                    x: x,
                    y: y,
                    size: 5 + Math.random() * 10,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    color: ['#ff4500', '#32cd32', '#ffd700', '#8b00ff'][Math.floor(Math.random() * 4)],
                    alpha: 1,
                    life: 30
                };
            }
            generateEmojis() {
                this.state.emojis = this.state.emojis.filter(emoji =>
                    (emoji.fadeOut <= 0 && emoji.shake <= 0 && !emoji.isClicked) &&
                    (Date.now() - emoji.creationTime < emoji.lifetime)
                );
                const needed = this.state.maxEmojisOnScreen - this.state.emojis.length;
                for (let i = 0; i < needed; i++) {
                    this.state.emojis.push(this.createEmoji());
                }
                const typesCount = {};
                this.state.emojis.forEach(emoji => {
                    typesCount[emoji.value] = (typesCount[emoji.value] || 0) + 1;
                });
                let hasPair = false;
                for (const type in typesCount) {
                    if (typesCount[type] >= 2) {
                        hasPair = true;
                        break;
                    }
                }
                if (!hasPair && this.state.emojis.length >= 2) {
                    this.state.emojis[0].value = this.state.emojis[1].value;
                }
            }
            drawEmoji(ctx, emoji) {
                if (emoji.fadeOut > 0) {
                    emoji.fadeOut -= 0.2;
                    ctx.globalAlpha = emoji.fadeOut;
                } else if (emoji.shake > 0) {
                    emoji.shake -= 1;
                    emoji.x += (Math.random() - 0.5) * 3;
                    emoji.y += (Math.random() - 0.5) * 3;
                } else {
                    emoji.x += emoji.vx;
                    emoji.y += emoji.vy;
                    if (emoji.x < 0 || emoji.x > ctx.canvas.width) emoji.vx *= -1;
                    if (emoji.y < 0 || emoji.y > ctx.canvas.height) emoji.vy *= -1;
                    emoji.wiggle += 0.1;
                }
                ctx.font = `bold ${emoji.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const colors = {
                    'üëª': '#FFFFFF',
                    'üéÉ': '#FFA500',
                    'üï∑Ô∏è': '#8B4513',
                    'ü¶á': '#4B0082',
                    'üíÄ': '#808080',
                    'üòà': '#FF0000'
                };
                ctx.save();
                ctx.translate(emoji.x, emoji.y);
                ctx.rotate(Math.sin(emoji.wiggle) * 0.1);
                ctx.fillStyle = emoji.isClicked ? '#ff8c00' : (colors[emoji.value] || '#ffffff');
                ctx.fillText(emoji.value, 0, 0);
                ctx.restore();
                ctx.globalAlpha = 1;
            }
            drawParticles(ctx) {
                this.state.particles = this.state.particles.filter(p => p.life > 0);
                this.state.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    p.alpha = p.life / 30;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${parseInt(p.color.slice(1, 3), 16)}, ${parseInt(p.color.slice(3, 5), 16)}, ${parseInt(p.color.slice(5, 7), 16)}, ${p.alpha})`;
                    ctx.fill();
                });
            }
            updateTimer() {
                const elapsed = Math.floor((Date.now() - this.state.startTime) / 1000);
                const remaining = 60 - elapsed;
                if (remaining <= 0) {
                    this.endCanvasGame();
                    return false;
                }
                this.elements.timerText.textContent = `‚è≥ –ß–ê–°: ${String(remaining).padStart(2, '0')}`;
                return true;
            }
            animate(time) {
                if (!this.state.isGameRunning || this.state.isGamePaused) return;
                const ctx = this.elements.canvas?.getContext('2d');
                if (!ctx) return;
                this.frameCount++;
                const now = performance.now();
                if (now - this.lastFrameTime >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFrameTime = now;
                    const color = this.fps > 45 ? '#0f0' : this.fps > 30 ? '#ff0' : '#f00';
                    this.elements.fpsCounter.textContent = `${Math.round(this.fps)} FPS`;
                    this.elements.fpsCounter.style.color = color;
                }
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                if (now - this.state.lastGeneration > this.state.generationInterval) {
                    this.generateEmojis();
                    this.state.lastGeneration = now;
                }
                this.drawParticles(ctx);
                this.state.emojis.forEach(emoji => this.drawEmoji(ctx, emoji));
                if (!this.updateTimer()) return;
                this.state.animationFrameId = requestAnimationFrame((t) => this.animate(t));
            }
            endCanvasGame() {
                this.state.isGameRunning = false;
                this.hideGameControls();
                this.elements.resetBtn.style.display = 'block';
                this.elements.taskText.style.display = 'none';
                this.elements.timerText.style.display = 'none';
                this.elements.scoreText.style.display = 'none';
                this.hideFeedback();
                this.elements.endMessage.textContent = `–°–£–ü–ï–†! –¢–ò –ó–õ–ê–ü–ê–í ${this.state.score / 2} –ü–ê–† –ú–û–ù–°–¢–†–Ü–í! üéÉ –ì–†–ê–¢–ò –©–ï? üëª`;
                this.elements.endMessage.style.display = 'block';
                this.elements.endMessage.classList.add('pulse');
                this.stopAllAudio();
                if (this.state.animationFrameId) {
                    cancelAnimationFrame(this.state.animationFrameId);
                    this.state.animationFrameId = null;
                }
                setTimeout(() => {
                    this.elements.endMessage.style.display = 'none';
                    this.elements.endMessage.classList.remove('pulse');
                    this.stopGame();
                }, 4000);
            }
            destroy() {
                if (this.resizeObserver) {
                    this.resizeObserver.disconnect();
                }
                if (this.inputHandler && this.elements.canvas) {
                    this.elements.canvas.removeEventListener('click', this.inputHandler);
                    this.elements.canvas.removeEventListener('touchstart', this.inputHandler);
                }
                if (this.state.animationFrameId) {
                    cancelAnimationFrame(this.state.animationFrameId);
                }
                if (this.state.logoAppearTimeout) {
                    clearTimeout(this.state.logoAppearTimeout);
                }
            }
        }
        let game = null;
        window.addEventListener('load', () => {
            game = new ARGame();
        });
        window.addEventListener('beforeunload', () => {
            if (game) game.destroy();
        });
    </script>
</body>
</html>
